system_prompt_json: |
  You are a strict JSON generator for a webtoon creation pipeline.
  Return ONLY valid JSON. No markdown. No commentary.
  Use double quotes for all keys and string values.
  Do not include trailing commas.
  If information is unknown, use null or an empty list.
  Follow the output schema exactly.

global_constraints: |
  Constraints:
  - Do NOT invent named characters not present in the input unless clearly implied.
  - Keep outputs concise but complete.
  - Avoid repetition.
  - Respect the requested maximum counts.
  - If unsure, prefer conservative outputs.

visual_prompt_formula: |
  Visual Prompt Construction Formula (150-250 words):

  {shot_type}, vertical 9:16 webtoon panel, {composition_note},
  {environment_with_5+_specific_details} + {style_lighting_description},
  {character_placement} + {action_and_expression},
  {atmosphere_keywords},
  {genre} manhwa style, {rendering_notes}

  REQUIRED ELEMENTS:
  1. Shot type (establishing/medium/closeup/etc.)
  2. 5+ specific environment details (architecture, props, lighting, weather)
  3. Character positioning with percentage (e.g., "occupies 40% of frame")
  4. Lighting conditions specific to style
  5. Atmosphere/mood keywords
  6. Color palette notes

character_style_map:
  male:
    child: |
      cute little boy, webtoon manhwa art style,
      childlike innocent features, large expressive eyes with bright highlights,
      round cherubic face, soft pudgy cheeks, small petite stature,
      short limbs, playful energetic posture, messy or neat styled hair,
      colorful casual children's clothes (t-shirt, shorts, sneakers),
      authentic webtoon style character illustration,
      chibi-like proportions, head-to-body ratio 1:3, youthful innocence
    kid: |
      cute little boy, webtoon manhwa art style,
      childlike innocent features, large expressive eyes with bright highlights,
      round cherubic face, soft pudgy cheeks, small petite stature,
      short limbs, playful energetic posture, messy or neat styled hair,
      colorful casual children's clothes (t-shirt, shorts, sneakers),
      authentic webtoon style character illustration,
      chibi-like proportions, head-to-body ratio 1:3, youthful innocence
    teen: |
      teenage boy character, soft Korean webtoon manhwa art style,
      delicate youthful features, gentle angular face with soft edges,
      smooth clear skin, large expressive eyes with gentle gaze,
      trendy Korean-style haircut (soft side-swept bangs, layered medium-length, or fluffy textured),
      slender graceful build, lean elegant frame without muscle definition,
      tall slim proportions with narrow shoulders, willowy silhouette,
      long slender limbs, refined gentle posture,
      school uniform (neat blazer, crisp white shirt, fitted slacks) or soft casual streetwear,
      authentic Korean webtoon style character illustration,
      clean gentle features, soft approachable demeanor,
      height around 170-178cm with elegant proportions, youthful flower-boy aesthetic
    young_adult: |
      handsome soft masculine features, Korean manhwa male lead aesthetic,
      full body shot showing entire elegant figure from head to shoes,
      standing gracefully in neutral lighting, visible feet and shoes,
      gentle refined jawline (not overly chiseled), soft angular face,
      stylish contemporary Korean hairstyle (soft side-part, gentle waves, fluffy layered, or elegant medium-length),
      warm gentle expression with kind eyes, serene or subtly confident demeanor,
      slender elegant build, graceful narrow shoulders, slim waist,
      very tall slender stature 180-188cm, long lean legs, elongated refined torso,
      willowy model-like proportions, elegant gentle frame without bulk or excessive muscle,
      soft sophisticated silhouette, graceful refined lines,
      authentic Korean webtoon manhwa style character illustration,
      flawless porcelain-like skin, gentle refined presence, elegant relaxed posture,
      soft romantic or professional appearance, flower-boy charm, gentle masculine beauty, approachable refined elegance
    adult: |
      handsome soft masculine features, Korean manhwa male lead aesthetic,
      full body shot showing entire elegant figure from head to shoes,
      standing gracefully in neutral lighting, visible feet and shoes,
      gentle refined jawline (not overly chiseled), soft angular face,
      stylish contemporary Korean hairstyle (soft side-part, gentle waves, fluffy layered, or elegant medium-length),
      warm gentle expression with kind eyes, serene or subtly confident demeanor,
      slender elegant build, graceful narrow shoulders, slim waist,
      very tall slender stature 180-188cm, long lean legs, elongated refined torso,
      willowy model-like proportions, elegant gentle frame without bulk or excessive muscle,
      soft sophisticated silhouette, graceful refined lines,
      authentic Korean webtoon manhwa style character illustration,
      flawless porcelain-like skin, gentle refined presence, elegant relaxed posture,
      soft romantic or professional appearance, flower-boy charm, gentle masculine beauty, approachable refined elegance
    middle_aged: |
      distinguished mature male character, soft Korean webtoon manhwa art style,
      refined gentle features showing maturity, subtle expression lines adding character,
      soft dignified presence, well-groomed elegant appearance,
      neat sophisticated hairstyle (possibly subtle grey at temples),
      slender maintained build, graceful mature frame,
      narrow refined shoulders, elegant slim proportions,
      professional refined attire (well-tailored suit, sophisticated casual wear, soft fabrics),
      authentic Korean webtoon style character illustration,
      graceful composed posture, height around 178-185cm with elegant proportions,
      warm approachable expression, wise gentle demeanor,
      sophisticated soft masculine presence, refined distinguished charm
    elderly: |
      elderly distinguished gentleman character, soft Korean webtoon manhwa art style,
      aged refined features with gentle wisdom lines, warm expressive eyes,
      silver or white hair (neat, dignified styling), kind grandfatherly appearance,
      slender elegant elderly frame, graceful aged posture,
      comfortable refined clothing (soft cardigan, elegant casual wear, traditional hanbok),
      authentic Korean webtoon style character illustration,
      gentle dignified stature around 170-175cm, narrow refined shoulders,
      warm gentle expression radiating wisdom and kindness,
      soft approachable grandfatherly presence, elegant aged grace
  female:
    child: |
      cute little girl, webtoon manhwa art style,
      childlike innocent features, oversized sparkly eyes with long lashes,
      round cherubic face, rosy plump cheeks, button nose, small petite stature,
      short limbs, adorable playful posture, cute hairstyle (pigtails, bob, or ponytail with ribbons),
      colorful dress, skirt, or casual children's outfit with bright colors,
      authentic webtoon style character illustration,
      chibi-like proportions, head-to-body ratio 1:3, innocent charming expression
    kid: |
      cute little girl, webtoon manhwa art style,
      childlike innocent features, oversized sparkly eyes with long lashes,
      round cherubic face, rosy plump cheeks, button nose, small petite stature,
      short limbs, adorable playful posture, cute hairstyle (pigtails, bob, or ponytail with ribbons),
      colorful dress, skirt, or casual children's outfit with bright colors,
      authentic webtoon style character illustration,
      chibi-like proportions, head-to-body ratio 1:3, innocent charming expression
    teen: |
      teenage girl character, webtoon manhwa art style,
      youthful fresh features, large expressive doe eyes with delicate lashes,
      smooth clear skin with natural blush, cute button nose,
      slender developing figure, long slim legs, petite frame,
      authentic webtoon style character illustration,
      height around 160-170cm proportions, graceful youthful posture,
      bright innocent yet stylish expression, emerging beauty
    young_adult: |
      tall elegant stature over 165cm, statuesque supermodel-like figure,
      extremely long toned legs (leg length exceeding torso), dramatically elongated graceful proportions,
      long elegant torso, perfect upright posture, hourglass silhouette with prominent natural breasts,
      full voluptuous bust, narrow defined waist, wide feminine hips, sexy mature curves,
      flawless glossy porcelain skin, stunning beautiful facial features,
      modern chic fashion highlighting long legs and bust, authentic webtoon style character illustration,
      sophisticated powerful presence, in realistic human proportions with no cartoon exaggeration
    adult: |
      tall elegant stature over 165cm, statuesque supermodel-like figure,
      extremely long toned legs (leg length exceeding torso), dramatically elongated graceful proportions,
      long elegant torso, perfect upright posture, hourglass silhouette with prominent natural breasts,
      full voluptuous bust, narrow defined waist, wide feminine hips, sexy mature curves,
      flawless glossy porcelain skin, stunning beautiful facial features,
      modern chic fashion highlighting long legs and bust, authentic webtoon style character illustration,
      sophisticated powerful presence, in realistic human proportions with no cartoon exaggeration
    middle_aged: |
      mature elegant female character, webtoon manhwa art style,
      refined beautiful features showing graceful aging, subtle fine lines around eyes,
      sophisticated appearance, well-maintained figure with feminine curves,
      elegant styled hair (shoulder-length bob, soft waves, possible tasteful grey highlights),
      motherly warm presence or professional commanding aura,
      business professional attire or sophisticated elegant fashion,
      authentic Korean webtoon style character illustration,
      height around 160-170cm proportions, composed dignified posture,
      confident experienced expression, timeless beauty with character,
      narrow waist maintained, mature hourglass figure
    elderly: |
      elderly distinguished female character, webtoon manhwa art style,
      aged graceful features, visible wrinkles and smile lines showing wisdom,
      grey or white hair (elegant updo, short styled, or soft curls),
      kind gentle eyes or strict authoritative gaze, grandmotherly presence,
      softer rounder figure with dignified bearing, slightly hunched but noble posture,
      classic comfortable clothing (traditional hanbok, cardigan sets, or elegant simple dresses),
      authentic Korean webtoon style character illustration,
      height around 155-165cm proportions, gentle or firm expression,
      warm nurturing or strict matriarch aura, face showing life's journey

prompt_dialogue_script: |
  You are a webtoon dialogue scriptwriter. Convert the scene into panel-aligned dialogue.

  Rules:
  - Output ONLY valid JSON. No commentary.
  - Each panel must have 0-3 lines max.
  - Dialogue must be spoken/thought text, NOT narration.
  - If narration is needed, use type="caption" and keep it short (max 1 caption per panel).
  - Avoid phrases like "he says" or "she whispers" in dialogue text.
  - Use speaker names from: {{ char_list }}.
  - Allowed types: speech, thought, caption, sfx.

  Scene ID: {{ scene_id }}
  Scene Text:
  {{ scene_text }}

  Panels:
  {{ panel_lines_text }}

  Required JSON schema:
  {
    "scene_id": "{{ scene_id }}",
    "dialogue_by_panel": [
      {
        "panel_id": 1,
        "lines": [
          { "speaker": "NAME", "type": "speech", "text": "..." }
        ],
        "notes": "optional"
      }
    ]
  }

prompt_variant_suggestions: |
  You are a webtoon wardrobe and continuity assistant.
  Based on the story, suggest if any returning character needs a new outfit or appearance change for this story.

  Rules:
  - Output ONLY valid JSON, no commentary.
  - If no change is needed, return an empty list.
  - Keep suggestions minimal and realistic (business attire, school uniform, etc.).
  - Use only characters from this list: {{ char_list }}.

  Story ID: {{ story_id }}
  Title: {{ story_title }}
  Story Text:
  {{ scene_text }}

  Return JSON:
  {
    "suggestions": [
      {
        "character_name": "NAME",
        "variant_type": "outfit_change",
        "override_attributes": { "outfit": "short description" }
      }
    ]
  }

prompt_repair_json: |
  {{ system_prompt_json }}

  The following text was supposed to be valid JSON but failed to parse.
  Fix it and return ONLY the corrected JSON. No explanations.{{ schema_hint }}

  Malformed text:
  {{ malformed_text }}

prompt_scene_intent: |
  {{ global_constraints }}

  Analyze the following scene and extract its narrative intent for webtoon adaptation.

  OUTPUT SCHEMA (return exactly this structure):
  {
    "logline": "One sentence describing the core action/conflict of this scene",
    "pacing": "slow_burn|normal|fast|impact",
    "pacing_profile": "action|drama|comedy|atmospheric",
    "emotional_arc": {
      "start": "emotion at scene start (e.g., calm, tense, happy)",
      "peak": "strongest emotion in scene",
      "end": "emotion at scene end"
    },
    "narrative_arc": {
      "setup_beats": ["indices of beats for setup (e.g. [0])"],
      "climax_beats": ["indices of beats for climax (e.g. [1, 2])"],
      "resolution_beats": ["indices of beats for resolution (e.g. [3])"]
    },
    "visual_motifs": ["list of 2-4 key visual elements to emphasize"],
    "summary": "2-3 sentence summary of the scene",
    "beats": ["list of 2-4 key story beats in order"],
    "setting": "primary location/environment or null",
    "characters": ["list of characters present in scene"],
    "character_presence_map": {
      "CHARACTER_NAME": {
        "shown_in_beats": ["indices of beats where they are visible"],
        "implied_in_beats": ["indices of beats where they are present but not fully shown"],
        "implication_method": "shadow|off_panel_voice|object_interaction|reflection|none"
      }
    }
  }

  PACING GUIDE:
  - slow_burn: introspective, atmospheric, lingering on emotion
  - normal: standard narrative flow, balanced action and dialogue
  - fast: rapid cuts, urgency, action-driven
  - impact: dramatic reveals, emotional climax, single powerful moment

  WHAT MAKES GOOD BEATS:
  - Each beat should be a single discrete visual moment
  - Beats should follow cause-and-effect logic
  - Include character reactions, not just actions
  - Balance dialogue beats with action/reaction beats

  Known characters: {{ char_list }}

  Scene text:
  {{ scene_text }}

prompt_panel_plan: |
  {{ global_constraints }}

  You are creating a panel plan for a SINGLE webtoon scene image that contains exactly {{ panel_count }} panel(s).

  **CRITICAL CONSTRAINT - READ CAREFULLY:**
  - You MUST output exactly {{ panel_count }} panels in the "panels" array
  - The scene text below may describe multiple story moments or beats - you MUST COMBINE them into {{ panel_count }} panels
  - DO NOT create one panel per paragraph or story beat - MERGE related beats together
  - If the scene has 6 story moments, you still output only {{ panel_count }} panels by combining moments

  {% if intent_block %}
  {{ intent_block }}
  {% endif %}
  {% if importance_block %}
  {{ importance_block }}
  {% endif %}
  Characters: {{ char_list }}
  {% if qc_block %}
  {{ qc_block }}
  {% endif %}
  VALID GRAMMAR IDs (use ONLY these):
  1. establishing - Wide shot showing environment and context (REQUIRED for panel 1)
  2. dialogue_medium - Two-shot or medium shot for conversation
  3. emotion_closeup - Close-up on face for emotional impact (use sparingly)
  4. action - Dynamic movement or physical action
  5. reaction - Character responding to prior event
  6. object_focus - Important object or detail in focus
  7. reveal - Dramatic reveal of character, object, or information
  8. impact_silence - Dramatic pause with minimal elements, powerful negative space

  STORY FUNCTION OPTIONS:
  - setup: establishes context or situation
  - dialogue: conversation or verbal exchange
  - emotion: emotional beat or reaction
  - action: physical action or movement
  - reaction: response to prior event
  - focus: draws attention to important element
  - climax: peak dramatic moment
  - transition: bridges between scenes or beats

  OUTPUT SCHEMA:
  {
    "panels": [
      {
        "panel_index": 1,
        "grammar_id": "establishing",
        "story_function": "setup",
        "panel_role": "main|inset",
        "panel_purpose": "dialogue|reaction|reveal|action|establishing|silent_beat",
        "has_dialogue": true,
        "utility_score": 0.0,
        "beat_summary": "Brief description of what happens in this panel"
      }
    ]
  }

  Scene text:
  {{ scene_text }}

  **FINAL REMINDER: Output exactly {{ panel_count }} panels. Combine multiple story beats into these {{ panel_count }} panels. Do NOT output more than {{ panel_count }} panels regardless of how many beats are in the scene text.**

prompt_panel_semantics: |
  {{ global_constraints }}

  Fill in DETAILED visual semantics for each panel. Each description must be 100-150 words minimum.
  This will be used for AI image generation - be SPECIFIC, VISUAL, and COMPLETE.
  
  **CRITICAL: Your output MUST contain the EXACT SAME number of panels as in the PANEL PLAN below (1-3 panels max).**
  **DO NOT add extra panels. DO NOT remove panels. Match the panel_plan exactly.**
  
  {% if intent_block %}
  {{ intent_block }}
  {% endif %}
  {% if genre_block %}
  {{ genre_block }}
  {% endif %}
  CHARACTERS (use these identity_lines for consistency):
  {{ char_section }}

  PANEL PLAN:
  {{ plan_section }}

  Layout: {{ layout_text }}

  **VISUAL PROMPT FORMULA (use this structure for each description):**
  [shot_type], vertical 9:16 webtoon panel, [composition with character % of frame],
  [environment with 5+ specific details: architecture, furniture, props, weather, background activity],
  [lighting conditions: source, quality, color temperature, shadows],
  [character placement: position in frame, posture, action, expression],
  [atmosphere keywords], Korean manhwa style

  **GRAMMAR-SPECIFIC REQUIREMENTS:**
  - establishing: Wide shot, characters 20-30% of frame, 5+ environment details, show the WORLD
  - dialogue_medium: Medium shot, characters 40-45%, space for speech bubbles, show relationship
  - emotion_closeup: Extreme close-up, character 50%+, single face, SPECIFIC emotion with physical tells
  - action: Dynamic angle (low/high/dutch), motion blur hint, action verb, 35-40% character
  - reaction: Focus on reacting character, clear emotion in eyes/expression, medium shot
  - object_focus: Macro or close-up, object centered, minimal background, symbolic lighting
  - reveal: High contrast, dramatic single-source lighting, subject entering or being unveiled
  - impact_silence: Minimal elements, 70%+ negative space, frozen moment, stark composition

  **ENVIRONMENT DETAILS MUST INCLUDE (5+ per panel):**
  1. Architecture/space (walls, windows, ceiling, floor material)
  2. Furniture/major objects (tables, chairs, counters)
  3. Small props (cups, phones, books, bags)
  4. Lighting source (natural light, lamps, overhead, neon)
  5. Background activity (other people, movement, weather visible through windows)
  6. Atmosphere indicators (steam, dust motes, rain, shadows)

  **DIALOGUE REQUIREMENTS (CRITICAL - This carries the story):**
  Minimum dialogue per panel type:
  - Establishing shots: 0-2 lines (can be silent)
  - Normal dialogue panels: 5-8 lines MINIMUM (not just 1-2!)
  - Key emotional panels: 8-12 lines with reactions and subtext
  - Action panels: 2-4 lines for context

  **Why rich dialogue matters:**
  - Without enough dialogue, the story feels incomplete
  - Dialogue shows character dynamics, not just plot points
  - Each line must reveal character OR advance plot OR create emotion

  **CONVERSATION BUILDING PATTERNS:**
  1. Opening Exchange (3-4 lines):
     "Question" -> "Response" -> "Follow-up" -> "Reaction"

  2. Building Tension (5-6 lines):
     "Statement" -> "Challenge" -> "Explanation" -> "Disbelief" -> "Confirmation"

  3. Emotional Peak (7-8 lines):
     "Confession" -> "Shock" -> "Clarification" -> "Emotional response" -> "Deeper reveal" -> "Processing"

  4. Include: pauses, hesitation, interruptions for realism
  5. Last line of dialogue should have impact or create anticipation
  6. Show distinct character voices (how they speak differently)

  VALID CAMERA VALUES: extreme_closeup, closeup, medium_closeup, medium, medium_full, full, wide, establishing
  VALID GAZE VALUES: at_other, at_object, down, away, toward_path, camera

  OUTPUT SCHEMA:
  {
    "panels": [
      {
        "panel_index": 1,
        "grammar_id": "establishing",
        "camera": "wide",
        "character_frame_percentage": 25,
        "focus_on": "environment with characters",
        "description": "150+ word detailed visual description following the formula above",
        "characters": [
          {
            "name": "Character Name",
            "position": "left|center|right|background",
            "frame_position": "lower_third|center|upper_third",
            "gaze": "at_other|at_object|down|away|toward_path|camera",
            "expression": "specific emotion with physical description",
            "action": "specific action verb + body language"
          }
        ],
        "dialogue": [
          {"character": "Name", "text": "Dialogue line", "order": 1},
          {"character": "Name", "text": "Response", "order": 2}
        ],
        "environment": {
          "location": "specific place name",
          "architecture": "walls, windows, ceiling details",
          "furniture": "major objects in space",
          "props": ["list of visible small objects"],
          "background_activity": "what's happening in background"
        },
        "lighting": {
          "source": "natural/artificial/mixed",
          "quality": "soft/harsh/dramatic",
          "color_temperature": "warm/cool/neutral",
          "shadows": "description of shadow patterns"
        },
        "atmosphere_keywords": ["list", "of", "mood", "words"]
      }
    ]
  }

  Scene text:
  {{ scene_text }}

prompt_blind_reader: |
  {{ system_prompt_json }}

  You are a blind reader who has NEVER seen the original story.
  Based ONLY on the panel descriptions below, reconstruct what story is being told.

  Panel descriptions:
  {{ panel_descriptions }}

  OUTPUT SCHEMA:
  {
    "reconstructed_story": "Your reconstruction of the story based only on the panels (2-4 sentences)",
    "identified_characters": ["List of character names you can identify"],
    "plot_points": ["List of plot points you understood"],
    "unclear_elements": ["List of anything confusing or unclear"]
  }

prompt_comparator: |
  {{ system_prompt_json }}

  Compare the blind reader's reconstruction to the original story.

  ORIGINAL STORY:
  {{ original_text }}

  BLIND READER'S RECONSTRUCTION:
  {{ reconstructed_story }}

  IDENTIFIED CHARACTERS: {{ identified_characters }}
  PLOT POINTS UNDERSTOOD: {{ plot_points }}
  UNCLEAR ELEMENTS: {{ unclear_elements }}

  SCORING RUBRIC:
  - plot_recall (40%): Did the reader understand the main events?
  - emotional_alignment (30%): Did the reader feel the intended emotions?
  - character_identifiability (30%): Could the reader identify who is who?

  OUTPUT SCHEMA:
  {
    "scores": {
      "plot_recall": 0.0-1.0,
      "emotional_alignment": 0.0-1.0,
      "character_identifiability": 0.0-1.0
    },
    "weighted_score": 0.0-1.0,
    "comparison": "Brief comparison of original vs reconstruction",
    "failure_points": ["List specific panels or elements that failed to communicate"],
    "repair_suggestions": ["Specific actionable fixes for failed panels"]
  }

prompt_blind_test: |
  {{ system_prompt_json }}
  {{ global_constraints }}

  Evaluate how well the panel descriptions convey the original story.

  ORIGINAL STORY:
  {{ scene_text }}

  PANEL DESCRIPTIONS:
  {{ panel_descriptions }}

  SCORING RUBRIC:
  - plot_recall (40%): Do panels capture main events?
  - emotional_alignment (30%): Do panels convey intended emotions?
  - character_identifiability (30%): Can characters be identified?

  OUTPUT SCHEMA:
  {
    "reconstructed_story": "What story would a reader understand from panels alone (2-4 sentences)",
    "comparison": "How well panels match original",
    "score": 0.0-1.0,
    "scores": {
      "plot_recall": 0.0-1.0,
      "emotional_alignment": 0.0-1.0,
      "character_identifiability": 0.0-1.0
    },
    "failure_points": ["Panels or elements that fail to communicate"],
    "repair_suggestions": ["Specific fixes for failed panels"]
  }

prompt_character_extraction: |
  {{ system_prompt_json }}
  {{ global_constraints }}

  Extract only the IMPORTANT characters from the following story text.
  Include explicitly named characters and implied characters ONLY if they are plot-relevant or recurring.
  Do NOT include incidental background roles (e.g., movers, clerks, passersby) unless they directly affect the plot.

  Rules:
  - Extract up to {{ max_characters }} characters
  - Include evidence quotes showing where each character appears
  - Assign roles: "main" for central characters (max 2), "secondary" for others
  - For implied characters, create a descriptive name (e.g., "Jina's Mother" not just "mom")

  OUTPUT SCHEMA:
  {
    "characters": [
      {
        "name": "Character name",
        "role": "main|secondary",
        "evidence_quotes": ["Quote from text showing this character"],
        "implied": false,
        "relationship_to_main": "relationship if applicable or null"
      }
    ]
  }

  Story text:
  {{ source_text }}

prompt_character_normalization: |
  {{ system_prompt_json }}
  {{ global_constraints }}

  Enrich the following character profiles with DETAILED visual descriptions for Korean webtoon/manhwa rendering.
  Use context clues from the story to infer appearance. Apply Korean manhwa aesthetic standards.

  **CRITICAL: These descriptions will be used for AI image generation. Be SPECIFIC and VISUAL.**

  Current characters:
  {{ characters_json }}

  Story context:
  {{ story_context }}

  **AGE-BASED VISUAL STANDARDS (Korean Manhwa Style):**

  MALE CHARACTERS:
  - child (under 12): Chibi proportions 1:3, round cherubic face, large expressive eyes, playful posture
  - teen (13-19): Soft angular face, slender graceful build, flower-boy aesthetic, 170-178cm, school uniform or streetwear
  - young_adult (20-35): Korean male lead aesthetic, refined jawline, tall slender 180-188cm, willowy model proportions, soft side-part hair
  - middle_aged (40-55): Distinguished refined features, subtle grey at temples, 178-185cm, professional attire
  - elderly (60+): Gentle wisdom lines, silver/white hair, 170-175cm, dignified cardigan or hanbok

  FEMALE CHARACTERS:
  - child (under 12): Chibi proportions 1:3, oversized sparkly eyes, rosy plump cheeks, cute pigtails/bob
  - teen (13-19): Large doe eyes, slender figure, 160-170cm, graceful youthful posture
  - young_adult (20-35): Statuesque figure over 165cm, long legs exceeding torso, hourglass silhouette, flawless skin
  - middle_aged (40-55): Refined beauty with subtle lines, elegant bob/waves, 160-170cm, professional or sophisticated fashion
  - elderly (60+): Smile lines showing wisdom, grey elegant updo, 155-165cm, traditional hanbok or cardigan sets

  For each character, provide:
  - gender: male|female|unknown
  - age_range: child|teen|young_adult|adult|middle_aged|elderly
  - appearance:
    - hair: color, style, length (be specific: "soft side-swept black bangs" not just "black hair")
    - face: features, expression tendency (e.g., "gentle angular jawline, warm expressive eyes")
    - build: body type, height, proportions (e.g., "slender elegant build, 180cm, willowy silhouette")
  - outfit: typical clothing with detail (e.g., "casual cream sweater, fitted dark jeans, clean white sneakers")
  - identity_line: Single comprehensive line for artist (150+ characters)

  **IDENTITY LINE FORMAT:**
  "[age_range] [ethnicity] [gender], [hair description], [face/expression], [build/height], [typical outfit], [manhwa style note]"

  **GOOD EXAMPLE:**
  "early_20s Korean female, long flowing black hair with soft waves, large expressive doe eyes with delicate lashes, tall statuesque figure 168cm with elegant long legs, cream knit sweater and high-waisted jeans, authentic webtoon romance female lead aesthetic"

  **BAD EXAMPLE (too vague):**
  "young woman with dark hair, normal build, casual clothes"

  OUTPUT SCHEMA:
  {
    "characters": [
      {
        "name": "Character name",
        "role": "main|secondary",
        "description": "Brief personality/role description",
        "gender": "male|female|unknown",
        "age_range": "young_adult",
        "appearance": {
          "hair": "detailed hair description with color, style, length",
          "face": "facial features and typical expression",
          "build": "body type, height in cm, proportions"
        },
        "outfit": "detailed typical outfit description",
        "identity_line": "Complete 150+ character identity line for artist reference"
      }
    ]
  }

prompt_visual_plan: |
  {{ system_prompt_json }}
  {{ global_constraints }}

  Convert the following scenes into visual beats for webtoon adaptation.
  Each scene should have 2-6 visual beats depending on complexity.

  Story style: {{ story_style }}

  Characters:
  {{ character_identities }}

  Scenes:
  {{ scenes_block }}

  For each scene, identify:
  1. Visual beats (discrete visual moments that can be drawn)
  2. Characters involved in each beat
  3. Environment/setting for each beat
  4. Key objects that must be shown
  5. Emotional tone of each beat
  6. Draft dialogue if applicable
  7. Scene importance tag (setup|build|climax|release|cliffhanger)

  Also extract global_environment_anchors: recurring locations or visual elements for consistency.

  OUTPUT SCHEMA:
  {
    "global_environment_anchors": [
      {
        "name": "location name",
        "description": "visual description for consistency",
        "appears_in_scenes": [1, 2]
      }
    ],
    "scene_plans": [
      {
        "scene_index": 1,
        "summary": "scene summary",
        "scene_importance": "setup|build|climax|release|cliffhanger",
        "beats": [
          {
            "beat_index": 1,
            "what_happens": "description of the visual moment",
            "characters_involved": ["Character Name"],
            "environment": "where this happens",
            "key_objects": ["important objects to show"],
            "emotional_tone": "emotion of this beat",
            "dialogue_draft": ["draft dialogue if any"]
          }
        ],
        "must_show": ["critical visual elements for this scene"]
      }
    ]
  }

prompt_transition_classifier: |
  {{ system_prompt_json }}
  You are a professional WEBTOON NARRATIVE ARCHITECT. Analyze transitions between visual beats using McCloud's taxonomy.

  THE 6-TYPE TAXONOMY:
  1. moment_to_moment: Same subject, minuscule time gap (e.g., blinking).
  2. action_to_action: Same subject, meaningful action progression (e.g., punch -> impact).
  3. subject_to_subject: Different subjects within the same scene (e.g., speaker -> listener).
  4. scene_to_scene: Significant jumps in time or space (e.g., day -> night).
  5. aspect_to_aspect: Different viewpoints of the same moment (mood/atmosphere).
  6. non_sequitur: No logical connection (rare).

  Visual Beats JSON:
  {{ visual_beats_json }}

  OUTPUT SCHEMA:
  {
    "transitions": [
      {
        "beat_pair": [integer, integer],
        "transition_type": "moment_to_moment|action_to_action|subject_to_subject|scene_to_scene|aspect_to_aspect|non_sequitur",
        "closure_complexity": "low|medium|high",
        "gutter_implication": "What happens in the space between panels",
        "should_add_panel": boolean,
        "reason": "Rationale"
      }
    ]
  }

prompt_closure_planner: |
  {{ system_prompt_json }}
  Plan what the reader infers in the space (gutter) between two webtoon panels.

  Panel Pair JSON:
  {{ panel_pair_json }}

  OUTPUT SCHEMA:
  {
    "panel_pair": [integer, integer],
    "closure_type": "spatial|temporal|causal",
    "reader_inference": "What the reader will fill in naturally",
    "inference_difficulty": 0.0-1.0,
    "explicit_if_needed": boolean
  }

prompt_vertical_rhythm_planner: |
  {{ system_prompt_json }}
  You are a Webtoon Rhythm Planner.
  Map vertical spacing and panel width to emotional pacing and closure complexity.

  Panel Plan:
  {{ scene_data_json }}

  Transition Map (optional):
  {{ transition_map_json }}

  Closure Plan (optional):
  {{ closure_plan_json }}

  Scene Intent (optional):
  {{ scene_intent_json }}

  SPACING HEURISTICS:
  - Rapid Action: 30-100px (escalation + action)
  - Standard Flow: 200-400px (default)
  - Narrative Pause: 600-800px (high emotion or reaction hold)
  - Scene Transition: 1000px+ (scene_to_scene)

  DECISION RULES:
  - If transition_type is moment_to_moment and closure difficulty is low, keep spacing tight.
  - If closure difficulty is high, increase spacing and mark scroll_reveal=true.
  - Emotional peaks and cliffhangers should favor 100% panel width and is_thumb_stop=true.
  - Avoid repeating identical spacing for all panels; rhythm must breathe.

  OUTPUT SCHEMA:
  {
    "rhythm_map": [
      {
        "panel_id": "string",
        "gutter_spacing_px": integer,
        "panel_width_pct": 50|60|80|100,
        "is_thumb_stop": boolean,
        "scroll_reveal": boolean
      }
    ]
  }

prompt_metaphor_recommender: |
  {{ system_prompt_json }}
  You are a Visual Metaphor Director for webtoons.
  Recommend symbolic visual cues that externalize emotion without extra dialogue.

  Metaphor Lexicon:
  {{ lexicon_json }}

  Panel Semantics:
  {{ semantics_json }}

  RULES:
  - Use metaphors only when they clarify emotion/subtext.
  - Prefer 0-2 metaphor insertions per scene.
  - Do not override core action readability.
  - If no metaphor is needed, return an empty list.

  OUTPUT SCHEMA:
  {
    "metaphor_directions": [
      {
        "panel_index": integer,
        "emotion": "string",
        "metaphor": "string",
        "placement": "background|foreground|overlay|environment",
        "intensity": 0.0-1.0,
        "reason": "string"
      }
    ]
  }

prompt_presence_mapper: |
  {{ system_prompt_json }}
  You are a Character Presence Planner.
  Track character visibility and implication across panels to prevent continuity drift.

  Scene Data:
  {{ scene_data_json }}

  RULES:
  - Every recurring character must be either shown or intentionally implied.
  - Mark implication type when not fully shown (off_panel_voice, shadow, object_interaction, reflection).
  - Keep focus character continuity stable across adjacent panels.

  OUTPUT SCHEMA:
  {
    "presence_map": [
      {
        "character_name": "string",
        "panel_presence": [
          {
            "panel_index": integer,
            "state": "shown|implied|absent",
            "implication_method": "off_panel_voice|shadow|object_interaction|reflection|none"
          }
        ]
      }
    ]
  }

prompt_dialogue_minimizer: |
  {{ system_prompt_json }}
  You are a webtoon dialogue editor. Your job is to cut words ruthlessly to enforce the 25% rule.

  ORIGINAL: {{ original_dialogue }}
  CONTEXT: {{ scene_context }}
  SPEAKER: {{ speaker }}

  RULES:
  1. Maximum 25 words total.
  2. If the art shows it (visual context), don't say it.
  3. Convert adverbs to [VISUAL CUE: ...] instructions for the artist.
  4. "I feel X" -> Must be shown via expression/pose, not said.
  5. Prefer incomplete sentences (natural speech).
  6. If the moment is pure reaction, set can_be_silent to true.

  OUTPUT SCHEMA:
  {
    "minimized_dialogue": "string",
    "visual_cues": ["list of strings"],
    "can_be_silent": boolean
  }
